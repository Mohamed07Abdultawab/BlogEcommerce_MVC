@using System.Linq
@model IEnumerable<BlogEcommerce.Models.Order>

@{
    ViewData["Title"] = "My Orders";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h4 mb-0">My Orders</h1>
        <a asp-action="Index" class="btn btn-outline-secondary">← Back to Profile</a>
    </div>

    @if (Model != null && Model.Any())
    {
            <div class="row">
            @foreach (var order in Model)
            {
                var badgeClass = order.Status switch
                {
                    "Pending" => "warning",
                    "Completed" => "success",
                    "Shipped" => "info",
                    "Processing" => "primary",
                    "Cancelled" => "danger",
                    _ => "secondary"
                };

                        <div class="col-12 mb-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-7">
                                            <h5 class="mb-1">Order #@order.Id</h5>
                                            <div class="text-muted small mb-2">
                                                Placed on @order.OrderDate.ToString("MMMM dd, yyyy HH:mm")
                                            </div>

                                            <div class="mb-2">
                                                <span class="badge bg-@badgeClass">@order.Status</span>
                                            </div>

                                            <div class="small">
                                                <strong>Items:</strong> @(order.OrderItems?.Sum(i => i.Quantity) ?? 0)
                                                &nbsp;|&nbsp;
                                                <strong>Total:</strong> $@order.TotalAmount.ToString("N2")
                                            </div>

                                            <div class="text-muted small mt-2">
                                                <strong>Shipping:</strong>
                                        @($"{order.Address}, {order.City} {order.ZipCode}")
                                            </div>
                                        </div>

                                        <div class="col-md-5 text-md-end mt-3 mt-md-0">
                                            <a asp-action="OrderDetails" asp-route-id="@order.Id" class="btn btn-primary btn-sm me-2">
                                                View Details
                                            </a>

                                    @if (string.Equals(order.Status, "Completed", StringComparison.OrdinalIgnoreCase))
                                    {
                                                    <form asp-action="Reorder" method="post" class="d-inline">
                                                        <input type="hidden" name="orderId" value="@order.Id" />
                                                        <button type="submit" class="btn btn-outline-secondary btn-sm">Reorder</button>
                                                    </form>
                                    }
                                        </div>
                                    </div>

                                    <hr />

                                    <div class="row">
                                @if (order.OrderItems != null && order.OrderItems.Any())
                                {
                                    var preview = order.OrderItems.Take(3).ToList();
                                    foreach (var item in preview)
                                    {
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="d-flex align-items-center">
                                                @* Product image is optional — show when available *@
                                                @if (item?.Product != null && !string.IsNullOrEmpty(item.Product.ImageUrl))
                                                {
                                                                        <img src="@item.Product.ImageUrl" alt="@item.Product.Name" style="width:56px; height:56px; object-fit:cover;" class="me-2 rounded" />
                                                }
                                                else
                                                {
                                                                        <div class="me-2 rounded" style="width:56px; height:56px; background:#f1f1f1; display:flex; align-items:center; justify-content:center;">
                                                                            <small class="text-muted">No image</small>
                                                                        </div>
                                                }

                                                                <div class="small">
                                                                    <div class="fw-semibold">@item.Product?.Name ?? "Unknown product"</div>
                                                                    <div class="text-muted">Qty: @item.Quantity</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                    }

                                    @if (order.OrderItems.Count() > 3)
                                    {
                                                        <div class="col-12 col-md-4 d-flex align-items-center">
                                                            <small class="text-muted">+@(order.OrderItems.Count() - 3) more item(s)</small>
                                                        </div>
                                    }
                                }
                                else
                                {
                                                <div class="col-12">
                                                    <small class="text-muted">No items in this order.</small>
                                                </div>
                                }
                                    </div>
                                </div> <!-- /.card-body -->
                            </div> <!-- /.card -->
                        </div> <!-- /.col -->
            }
            </div> <!-- /.row -->
    }
    else
    {
            <div class="alert alert-info text-center">
                <h5 class="mb-1">No Orders Yet</h5>
                <p class="mb-3">You haven't placed any orders yet.</p>
                <a asp-controller="Products" asp-action="Index" class="btn btn-primary">Start Shopping</a>
            </div>
    }
</div>

@section Scripts {
        <script>
            (function () {
                // Optional: confirm before calling Reorder (if action exists)
                document.querySelectorAll('form[action$="Reorder"]').forEach(function (f) {
                    f.addEventListener('submit', function (e) {
                        if (!confirm('Are you sure you want to reorder these items?')) {
                            e.preventDefault();
                        }
                    });
                });
            })();
        </script>
}
