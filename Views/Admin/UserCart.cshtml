@model IEnumerable<BlogEcommerce.Models.CartItem>

@{
    ViewData["Title"] = $"Cart for {ViewBag.UserEmail}";
    decimal total = 0;
}

<div class="container-xl py-5">

    <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
        <h1 class="page-title fw-bold">🛒 Cart for <span class="text-primary-accent">@ViewBag.UserEmail</span></h1>
        <a asp-action="AllCarts" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i> Back to All Carts
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
            <div class="alert alert-success-custom alert-dismissible fade show mb-4" role="alert">
                <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
            <div class="alert alert-danger-custom alert-dismissible fade show mb-4" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
    }

    @if (Model.Any())
    {
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card admin-cart-details-card shadow-sm">
                        <div class="card-header bg-gray-light">
                            <h5 class="mb-0 fw-bold text-primary-text"><i class="fas fa-cubes me-2"></i> Cart Items</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-monochrome table-hover table-details mb-0">
                                    <thead>
                                        <tr class="table-header-monochrome">
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th style="width: 100px;">Quantity</th>
                                            <th>Subtotal</th>
                                            <th style="width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var item in Model)
                                    {
                                        var subtotal = item.Product!.Price * item.Quantity;
                                        total += subtotal;

                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(item.Product.ImageUrl))
                                                    {
                                                            <img src="@item.Product.ImageUrl" alt="@item.Product.Name" class="cart-item-img-small me-3">
                                                    }
                                                        <div>
                                                            <h6 class="mb-0 fw-bold text-primary-link">@item.Product.Name</h6>
                                                            <small class="text-secondary">@item.Product.Category</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="align-middle">$@item.Product.Price.ToString("N2")</td>

                                                <td class="align-middle text-center">
                                                    <span class="fw-bold fs-5 text-primary-text">@item.Quantity</span>
                                                </td>

                                                <td class="align-middle"><strong class="text-error-accent">$@subtotal.ToString("N2")</strong></td>

                                                <td class="align-middle">
                                                    <button type="button" class="btn btn-sm btn-danger-custom" onclick="deleteItem(@item.Id, '@ViewBag.UserId', '@item.Product.Name')">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">

                    <div class="card order-summary-card shadow-sm sticky-top-custom-admin mb-4">
                        <div class="card-header bg-custom-dark text-white">
                            <h5 class="mb-0 fw-bold">Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2 summary-row">
                                <span>Total Items:</span>
                                <strong>@Model.Sum(i => i.Quantity)</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2 summary-row">
                                <span>Subtotal:</span>
                                <span>$@total.ToString("N2")</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 summary-row">
                                <span>Shipping:</span>
                                <span class="text-success-accent fw-bold">Free</span>
                            </div>
                            <hr class="summary-divider" />
                            <div class="d-flex justify-content-between mb-3 total-row">
                                <strong class="fs-5">Total Value:</strong>
                                <strong class="text-error-accent fs-4">$@total.ToString("N2")</strong>
                            </div>

                            <button type="button" class="btn btn-danger-custom btn-lg w-100" onclick="clearUserCart('@ViewBag.UserId', '@ViewBag.UserEmail')">
                                <i class="fas fa-times-circle me-2"></i> Clear Entire Cart
                            </button>
                        </div>
                    </div>

                    <div class="card mt-3 admin-info-card shadow-sm">
                        <div class="card-header bg-gray-light">
                            <h6 class="mb-0 fw-bold text-primary-text">Admin Insight</h6>
                        </div>
                        <div class="card-body small">
                            <p class="text-muted mb-0">This view allows you to review and clear the user's cart. Direct quantity modification is restricted.</p>
                        </div>
                    </div>
                </div>
            </div>
    }
    else
    {
            <div class="alert alert-info-custom text-center py-5 my-5">
                <i class="fas fa-shopping-bag fa-5x text-secondary-text mb-4"></i>
                <h4 class="fw-bold text-primary-text">Cart is Empty</h4>
                <p class="text-secondary fs-5 mb-4">This user doesn't have any items in their cart.</p>
                <a asp-action="AllCarts" class="btn btn-primary-accent btn-lg">
                    <i class="fas fa-arrow-left me-2"></i> View Other Carts
                </a>
            </div>
    }
</div>

<form id="deleteItemForm" asp-action="DeleteCartItem" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="deleteItemId" />
    <input type="hidden" name="userId" id="deleteItemUserId" />
</form>

<form id="clearCartForm" asp-action="ClearUserCart" method="post" style="display: none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="userId" id="clearCartUserId" />
</form>

@section Scripts {
        <script>
            function deleteItem(itemId, userId, productName) {
                if (confirm(`Are you sure you want to remove "${productName}" from this cart?`)) {
                    document.getElementById('deleteItemId').value = itemId;
                    document.getElementById('deleteItemUserId').value = userId;
                    document.getElementById('deleteItemForm').submit();
                }
            }

            function clearUserCart(userId, userEmail) {
                if (confirm(`Are you sure you want to clear ALL items from ${userEmail}'s cart? This action cannot be undone.`)) {
                    document.getElementById('clearCartUserId').value = userId;
                    document.getElementById('clearCartForm').submit();
                }
            }
        </script>
}