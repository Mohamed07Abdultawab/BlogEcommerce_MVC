@using System.Collections
@using System.Linq
@{
    ViewData["Title"] = "Statistics";

    // Safe server-side conversions (works with List<AnonymousType> too)
    var ordersByStatus = ViewBag.OrdersByStatus == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.OrdersByStatus).Cast<dynamic>().ToList();

    var revenueByMonth = ViewBag.RevenueByMonth == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.RevenueByMonth).Cast<dynamic>().ToList();

    var topProducts = ViewBag.TopProducts == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.TopProducts).Cast<dynamic>().ToList();

    // Pre-calc totals to avoid inline dynamic arithmetic issues
    int totalOrders = 0;
    decimal totalRevenue = 0m;
    if (revenueByMonth.Any())
    {
        foreach (var r in revenueByMonth)
        {
            // handle possible types (int, long, decimal, double)
            int oc = 0;
            decimal rev = 0m;
            try { oc = (int)r.OrderCount; } catch { oc = Convert.ToInt32(r.OrderCount); }
            try { rev = Convert.ToDecimal(r.Revenue); } catch { rev = 0m; }

            totalOrders += oc;
            totalRevenue += rev;
        }
    }
}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Detailed Statistics</h1>
        <a asp-action="Dashboard" class="btn btn-secondary">← Back to Dashboard</a>
    </div>

    <!-- Orders by Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Orders by Status</h5>
                </div>
                <div class="card-body">
                    @if (ordersByStatus.Any())
                    {
                            <div class="row">
                            @foreach (var item in ordersByStatus)
                            {
                                var status = item.Status ?? "";
                                var count = 0;
                                try { count = (int)item.Count; } catch { count = Convert.ToInt32(item.Count); }
                                var bgColor = status == "Pending" ? "warning" :
                                              status == "Completed" ? "success" :
                                              status == "Shipped" ? "info" :
                                              status == "Processing" ? "primary" : "secondary";

                                        <div class="col-md-2 col-sm-4 mb-3">
                                            <div class="card text-white bg-@bgColor">
                                                <div class="card-body text-center">
                                                    <h3 class="mb-0">@count</h3>
                                                    <p class="mb-0"><small>@status</small></p>
                                                </div>
                                            </div>
                                        </div>
                            }
                            </div>

                            @* <canvas id="orderStatusChart" height="80"></canvas> *@
                                <!-- Chart Container with Fixed Size -->
                            <div class="row">
                                <div class="col-md-6 offset-md-3">
                                    <div style="position: relative; height: 400px;">
                                        <canvas id="orderStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                    }
                    else
                    {
                            <p class="text-muted text-center">No order data available.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue by Month -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Revenue Trend (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    @if (revenueByMonth.Any())
                    {
                            <div class="table-responsive mb-4">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                            <th>Avg Order Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var item in revenueByMonth)
                                    {
                                        int orderCount = 0;
                                        decimal revenue = 0m;
                                        try { orderCount = (int)item.OrderCount; } catch { orderCount = Convert.ToInt32(item.OrderCount); }
                                        try { revenue = Convert.ToDecimal(item.Revenue); } catch { revenue = 0m; }

                                        var monthName = "--";
                                        try
                                        {
                                            monthName = new DateTime((int)item.Year, (int)item.Month, 1).ToString("MMMM yyyy");
                                        }
                                        catch
                                        {
                                            // fallback if Year/Month not ints
                                            monthName = $"{item.Month}/{item.Year}";
                                        }

                                        var avgOrder = orderCount > 0 ? revenue / orderCount : 0m;

                                            <tr>
                                                <td><strong>@monthName</strong></td>
                                                <td>@orderCount</td>
                                                <td class="text-success"><strong>$@revenue.ToString("N2")</strong></td>
                                                <td>$@avgOrder.ToString("N2")</td>
                                            </tr>
                                    }
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-primary">
                                            <td><strong>Total</strong></td>
                                            <td><strong>@totalOrders</strong></td>
                                            <td><strong>$@totalRevenue.ToString("N2")</strong></td>
                                            <td>-</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <canvas id="revenueChart" height="80"></canvas>
                    }
                    else
                    {
                            <p class="text-muted text-center">No revenue data available for the last 6 months.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Top Selling Products -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top 10 Best Selling Products</h5>
                </div>
                <div class="card-body">
                    @if (topProducts.Any())
                    {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Product Name</th>
                                            <th>Units Sold</th>
                                            <th>Total Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @{
                                        int rank = 1;
                                    }
                                    @foreach (var product in topProducts)
                                    {
                                        int qty = 0;
                                        decimal trev = 0m;
                                        try { qty = (int)product.TotalQuantity; } catch { qty = Convert.ToInt32(product.TotalQuantity); }
                                        try { trev = Convert.ToDecimal(product.TotalRevenue); } catch { trev = 0m; }

                                            <tr>
                                                <td>
                                                @if (rank == 1)
                                                {
                                                            <span class="badge bg-warning">🥇 @rank</span>
                                                }
                                                else if (rank == 2)
                                                {
                                                            <span class="badge bg-secondary">🥈 @rank</span>
                                                }
                                                else if (rank == 3)
                                                {
                                                            <span class="badge bg-danger">🥉 @rank</span>
                                                }
                                                else
                                                {
                                                            <span class="badge bg-light text-dark">@rank</span>
                                                }
                                                </td>
                                                <td><strong>@(product.ProductName ?? "")</strong></td>
                                                <td>
                                                    <span class="badge bg-primary">@qty units</span>
                                                </td>
                                                <td class="text-success"><strong>$@trev.ToString("N2")</strong></td>
                                            </tr>
                                        rank++;
                                    }
                                    </tbody>
                                </table>
                            </div>

                            <canvas id="topProductsChart" height="100"></canvas>
                    }
                    else
                    {
                            <p class="text-muted text-center">No sales data available yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Orders by Status Chart
        @if (ordersByStatus.Any())
        {
            <text>
                        const orderStatusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ordersByStatus));
                        const statusLabels = orderStatusData.map(item => item.Status);
                        const statusCounts = orderStatusData.map(item => item.Count);
                        const statusColors = statusLabels.map(status => {
                            switch(status) {
                                case 'Pending': return '#ffc107';
                                case 'Processing': return '#0d6efd';
                                case 'Shipped': return '#0dcaf0';
                                case 'Completed': return '#198754';
                                case 'Cancelled': return '#6c757d';
                                default: return '#6c757d';
                            }
                        });

                        new Chart(document.getElementById('orderStatusChart'), {
                            type: 'doughnut',
                            data: {
                                labels: statusLabels,
                                datasets: [{
                                    data: statusCounts,
                                    backgroundColor: statusColors
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom' },
                                    title: { display: true, text: 'Order Distribution by Status' }
                                }
                            }
                        });
            </text>
        }

            // Revenue by Month Chart
        @if (revenueByMonth.Any())
        {
            <text>
                        const revenueData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenueByMonth));
                        const monthLabels = revenueData.map(item => {
                            const date = new Date(item.Year, item.Month - 1);
                            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        });
                        const revenueValues = revenueData.map(item => item.Revenue);
                        const orderCounts = revenueData.map(item => item.OrderCount);

                        new Chart(document.getElementById('revenueChart'), {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Revenue ($)',
                                    data: revenueValues,
                                    borderColor: '#198754',
                                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }, {
                                    label: 'Orders',
                                    data: orderCounts,
                                    borderColor: '#0d6efd',
                                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                interaction: { mode: 'index', intersect: false },
                                plugins: { title: { display: true, text: 'Monthly Revenue and Order Trends' } },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: { display: true, text: 'Revenue ($)' }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: { display: true, text: 'Orders' },
                                        grid: { drawOnChartArea: false }
                                    }
                                }
                            }
                        });
            </text>
        }

            // Top Products Chart
        @if (topProducts.Any())
        {
            <text>
                        const topProducts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(topProducts));
                        const productNames = topProducts.map(item => item.ProductName.length > 20 ? item.ProductName.substring(0, 20) + '...' : item.ProductName);
                        const productQuantities = topProducts.map(item => item.TotalQuantity);

                        new Chart(document.getElementById('topProductsChart'), {
                            type: 'bar',
                            data: {
                                labels: productNames,
                                datasets: [{
                                    label: 'Units Sold',
                                    data: productQuantities,
                                    // let Chart.js default colors (no hard-coded colors required)
                                    borderColor: '#0d6efd',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false },
                                    title: { display: true, text: 'Top Selling Products by Units' }
                                },
                                scales: {
                                    x: { beginAtZero: true, title: { display: true, text: 'Units Sold' } }
                                }
                            }
                        });
            </text>
        }
        </script>
}
