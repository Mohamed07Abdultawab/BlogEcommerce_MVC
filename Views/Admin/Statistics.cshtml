@using System.Collections
@using System.Linq
@{
    ViewData["Title"] = "Detailed Statistics";

    // Safe server-side conversions (works with List<AnonymousType> too)
    var ordersByStatus = ViewBag.OrdersByStatus == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.OrdersByStatus).Cast<dynamic>().ToList();

    var revenueByMonth = ViewBag.RevenueByMonth == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.RevenueByMonth).Cast<dynamic>().ToList();

    var topProducts = ViewBag.TopProducts == null
        ? new List<dynamic>()
        : ((IEnumerable)ViewBag.TopProducts).Cast<dynamic>().ToList();

    // Pre-calc totals
    int totalOrders = 0;
    decimal totalRevenue = 0m;
    if (revenueByMonth.Any())
    {
        foreach (var r in revenueByMonth)
        {
            int oc = 0;
            decimal rev = 0m;
            try { oc = (int)r.OrderCount; } catch { oc = Convert.ToInt32(r.OrderCount); }
            try { rev = Convert.ToDecimal(r.Revenue); } catch { rev = 0m; }

            totalOrders += oc;
            totalRevenue += rev;
        }
    }

    // Status Color mapping function (used for cards)
    string GetBgColorClass(string status) => status switch
    {
        "Pending" => "bg-warning-custom text-dark",
        "Completed" => "bg-success-accent text-white",
        "Shipped" => "bg-info-accent text-white",
        "Processing" => "bg-primary-accent text-white",
        "Cancelled" => "bg-danger-custom text-white",
        _ => "bg-secondary-monochrome text-white"
    };
}
<div class="container-xl py-5">

    <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
        <h1 class="page-title fw-bold"><i class="fas fa-chart-bar me-2"></i> Detailed Statistics</h1>
        <a asp-action="Dashboard" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
        </a>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card dashboard-card shadow-sm">
                <div class="card-header bg-gray-light">
                    <h5 class="mb-0 fw-bold text-primary-text">Orders by Status Distribution</h5>
                </div>
                <div class="card-body">
                    @if (ordersByStatus.Any())
                    {
                            <div class="row g-3 mb-4">
                            @foreach (var item in ordersByStatus)
                            {
                                var status = item.Status ?? "";
                                var count = 0;
                                try { count = (int)item.Count; } catch { count = Convert.ToInt32(item.Count); }
                                var bgColor = GetBgColorClass(status);

                                    <div class="col-md-2 col-sm-4">
                                        <div class="card stat-mini-card @bgColor h-100">
                                            <div class="card-body text-center p-3">
                                                <h3 class="mb-0 fw-bold">@count</h3>
                                                <p class="mb-0 small-title">@status</p>
                                            </div>
                                        </div>
                                    </div>
                            }
                            </div>

                            <div class="row">
                                <div class="col-md-6 offset-md-3">
                                    <div class="chart-container-fixed">
                                        <canvas id="orderStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                    }
                    else
                    {
                            <p class="text-muted text-center py-3">No order data available.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card dashboard-card shadow-sm">
                <div class="card-header bg-gray-light">
                    <h5 class="mb-0 fw-bold text-primary-text">Revenue Trend (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    @if (revenueByMonth.Any())
                    {
                            <div class="table-responsive mb-4">
                                <table class="table table-monochrome table-hover monthly-revenue-table">
                                    <thead>
                                        <tr class="table-header-monochrome">
                                            <th>Month</th>
                                            <th>Orders</th>
                                            <th>Revenue</th>
                                            <th>Avg Order Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var item in revenueByMonth)
                                    {
                                        int orderCount = 0;
                                        decimal revenue = 0m;
                                        try { orderCount = (int)item.OrderCount; } catch { orderCount = Convert.ToInt32(item.OrderCount); }
                                        try { revenue = Convert.ToDecimal(item.Revenue); } catch { revenue = 0m; }

                                        var monthName = "--";
                                        try
                                        {
                                            monthName = new DateTime((int)item.Year, (int)item.Month, 1).ToString("MMMM yyyy");
                                        }
                                        catch
                                        {
                                            monthName = $"{item.Month}/{item.Year}";
                                        }

                                        var avgOrder = orderCount > 0 ? revenue / orderCount : 0m;

                                            <tr>
                                                <td><strong>@monthName</strong></td>
                                                <td>@orderCount</td>
                                                <td><strong class="text-success-accent">$@revenue.ToString("N2")</strong></td>
                                                <td>$@avgOrder.ToString("N2")</td>
                                            </tr>
                                    }
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-total-row">
                                            <td><strong>Total</strong></td>
                                            <td><strong>@totalOrders</strong></td>
                                            <td><strong class="text-error-accent">$@totalRevenue.ToString("N2")</strong></td>
                                            <td>-</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <canvas id="revenueChart" height="80"></canvas>
                    }
                    else
                    {
                            <p class="text-muted text-center py-3">No revenue data available for the last 6 months.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card shadow-sm">
                <div class="card-header bg-gray-light">
                    <h5 class="mb-0 fw-bold text-primary-text">Top 10 Best Selling Products</h5>
                </div>
                <div class="card-body">
                    @if (topProducts.Any())
                    {
                            <div class="table-responsive">
                                <table class="table table-monochrome table-hover top-products-table">
                                    <thead>
                                        <tr class="table-header-monochrome">
                                            <th>#</th>
                                            <th>Product Name</th>
                                            <th>Units Sold</th>
                                            <th>Total Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @{
                                        int rank = 1;
                                    }
                                    @foreach (var product in topProducts)
                                    {
                                        int qty = 0;
                                        decimal trev = 0m;
                                        try { qty = (int)product.TotalQuantity; } catch { qty = Convert.ToInt32(product.TotalQuantity); }
                                        try { trev = Convert.ToDecimal(product.TotalRevenue); } catch { trev = 0m; }

                                            <tr>
                                                <td>
                                                @if (rank == 1)
                                                {
                                                            <span class="badge badge-lg bg-warning-custom text-dark fw-bold">🥇 @rank</span>
                                                }
                                                else if (rank == 2)
                                                {
                                                            <span class="badge badge-lg bg-secondary-monochrome text-white fw-bold">🥈 @rank</span>
                                                }
                                                else if (rank == 3)
                                                {
                                                            <span class="badge badge-lg bg-danger-custom fw-bold">🥉 @rank</span>
                                                }
                                                else
                                                {
                                                            <span class="badge badge-lg bg-gray-light text-primary">@rank</span>
                                                }
                                                </td>
                                                <td><a href="#" class="text-primary-link fw-bold">@(product.ProductName ?? "")</a></td>
                                                <td>
                                                    <span class="fw-bold text-primary-accent">@qty units</span>
                                                </td>
                                                <td><strong class="text-success-accent">$@trev.ToString("N2")</strong></td>
                                            </tr>
                                        rank++;
                                    }
                                    </tbody>
                                </table>
                            </div>
                            <canvas id="topProductsChart" height="100"></canvas>
                    }
                    else
                    {
                            <p class="text-muted text-center py-3">No sales data available yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Data passed from Razor is raw. Chart.js code remains mostly the same, 
            // but we ensure colors match the new CSS variables (or use Chart.js defaults for Monochrome).

            // Order Status Chart (Doughnut)
        @if (ordersByStatus.Any())
        {
            <text>
                        const orderStatusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ordersByStatus));
                        const statusLabels = orderStatusData.map(item => item.Status);
                        const statusCounts = orderStatusData.map(item => item.Count);
                        // Map CSS Accent Colors to Chart.js
                        const statusColors = statusLabels.map(status => {
                            switch(status) {
                                case 'Pending': return '#FFC107'; // Warning Yellow
                                case 'Processing': return '#007BFF'; // Primary Blue
                                case 'Shipped': return '#17A2B8'; // Info Cyan
                                case 'Completed': return '#28A745'; // Success Green
                                case 'Cancelled': return '#DC3545'; // Danger Red
                                default: return '#6c757d'; // Secondary Gray
                            }
                        });

                        new Chart(document.getElementById('orderStatusChart'), {
                            type: 'doughnut',
                            data: {
                                labels: statusLabels,
                                datasets: [{
                                    data: statusCounts,
                                    backgroundColor: statusColors
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom' },
                                    title: { display: true, text: 'Order Distribution by Status', color: '#333' }
                                }
                            }
                        });
            </text>
        }

            // Revenue by Month Chart (Line)
        @if (revenueByMonth.Any())
        {
            <text>
                        const revenueData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenueByMonth));
                        const monthLabels = revenueData.map(item => {
                            const date = new Date(item.Year, item.Month - 1);
                            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        });
                        const revenueValues = revenueData.map(item => item.Revenue);
                        const orderCounts = revenueData.map(item => item.OrderCount);

                        new Chart(document.getElementById('revenueChart'), {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Revenue ($)',
                                    data: revenueValues,
                                    borderColor: '#28A745', // Success Green
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y'
                                }, {
                                    label: 'Orders',
                                    data: orderCounts,
                                    borderColor: '#007BFF', // Primary Blue
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                interaction: { mode: 'index', intersect: false },
                                plugins: { title: { display: true, text: 'Monthly Revenue and Order Trends', color: '#333' } },
                                scales: {
                                    y: { position: 'left', title: { display: true, text: 'Revenue ($)', color: '#333' } },
                                    y1: { position: 'right', title: { display: true, text: 'Orders', color: '#333' }, grid: { drawOnChartArea: false } }
                                }
                            }
                        });
            </text>
        }

            // Top Products Chart (Bar)
        @if (topProducts.Any())
        {
            <text>
                        const topProducts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(topProducts));
                        const productNames = topProducts.map(item => item.ProductName.length > 20 ? item.ProductName.substring(0, 20) + '...' : item.ProductName);
                        const productQuantities = topProducts.map(item => item.TotalQuantity);

                        new Chart(document.getElementById('topProductsChart'), {
                            type: 'bar',
                            data: {
                                labels: productNames,
                                datasets: [{
                                    label: 'Units Sold',
                                    data: productQuantities,
                                    backgroundColor: '#007BFF', // Primary Blue
                                    borderColor: '#0056b3',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false },
                                    title: { display: true, text: 'Top Selling Products by Units', color: '#333' }
                                },
                                scales: {
                                    x: { beginAtZero: true, title: { display: true, text: 'Units Sold', color: '#333' } }
                                }
                            }
                        });
            </text>
        }
        </script>
}